<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JSON Formatter â€” SmallTools</title>
  <link rel="stylesheet" href="../../assets/style.css">
  <script>(function(){const t=localStorage.getItem('st-theme')||'light';document.documentElement.setAttribute('data-theme',t);})();</script>
  <style>
    .json-cols{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:640px){.json-cols{grid-template-columns:1fr}}
    .json-out{font-family:"SF Mono","Fira Code",monospace;font-size:12.5px;background:var(--surface-2,#f8fafc);border:1.5px solid var(--border);border-radius:7px;padding:12px;min-height:300px;overflow:auto;white-space:pre;color:var(--text);line-height:1.6}
    .jk{color:#7c3aed}.jv{color:#059669}.js{color:#b91c1c}.jn{color:#2563eb}.jb{color:#d97706}
    [data-theme="dark"] .jk{color:#a78bfa}[data-theme="dark"] .jv{color:#34d399}[data-theme="dark"] .js{color:#fca5a5}[data-theme="dark"] .jn{color:#60a5fa}[data-theme="dark"] .jb{color:#fbbf24}
    .json-out.error{border-color:#dc2626}
    .tree-node{padding-left:18px}
    .tree-key{color:#7c3aed;font-weight:600}
    [data-theme="dark"] .tree-key{color:#a78bfa}
    .tree-toggle{display:inline-block;width:14px;text-align:center;cursor:pointer;color:var(--text-2);user-select:none}
    .tree-str{color:#b91c1c}[data-theme="dark"] .tree-str{color:#fca5a5}
    .tree-num{color:#2563eb}[data-theme="dark"] .tree-num{color:#60a5fa}
    .tree-bool,.tree-null{color:#d97706}[data-theme="dark"] .tree-bool,[data-theme="dark"] .tree-null{color:#fbbf24}
    .tree-collapsed>.tree-children{display:none}
    .tab-bar{display:flex;gap:0;border-bottom:2px solid var(--border);margin-bottom:14px}
    .tab-btn{padding:7px 18px;border:none;background:none;cursor:pointer;font-size:13px;font-weight:600;color:var(--text-2);border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .15s}
    .tab-btn.active{color:var(--primary);border-bottom-color:var(--primary)}
    .tab-btn:hover:not(.active){color:var(--text)}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container" style="display:flex;align-items:center;justify-content:space-between;padding:10px 20px">
      <a href="../../index.html" class="logo logo-sm">Small<span>Tools</span></a>
      <button class="theme-toggle" id="themeToggle">ðŸŒ™</button>
    </div>
  </header>
  <main class="tool-page" style="max-width:980px">
    <div class="breadcrumb"><a href="../../index.html">Home</a> / Dev / JSON Formatter</div>
    <div class="tool-header">
      <h1>{ } JSON Formatter</h1>
      <p>Format, validate, minify, repair, and explore JSON data with tree view.</p>
    </div>
    <div class="card">
      <div class="tab-bar">
        <button class="tab-btn active" id="tab-format" onclick="switchTab('format')">Format</button>
        <button class="tab-btn" id="tab-tree" onclick="switchTab('tree')">Tree View</button>
        <button class="tab-btn" id="tab-repair" onclick="switchTab('repair')">Repair</button>
      </div>

      <div id="pane-format">
        <div class="btn-group" style="margin-bottom:14px">
          <button class="btn btn-primary" onclick="format(2)">Format (2 spaces)</button>
          <button class="btn btn-ghost" onclick="format(4)">Format (4 spaces)</button>
          <button class="btn btn-ghost" onclick="minify()">Minify</button>
          <button class="btn btn-ghost" onclick="clearAll()">Clear</button>
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;font-weight:400;cursor:pointer;margin-left:4px"><input type="checkbox" id="sortKeys"> Sort keys</label>
        </div>
        <div class="json-cols">
          <div>
            <label style="margin-bottom:6px">Input JSON</label>
            <textarea id="input" rows="18" style="font-family:'SF Mono','Fira Code',monospace;font-size:12.5px" placeholder='{"name":"John","age":30}' oninput="liveValidate()"></textarea>
          </div>
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <label style="margin:0">Output</label>
              <button class="btn btn-copy" id="copyOutBtn" onclick="copyOut()">Copy</button>
            </div>
            <div class="json-out" id="output"></div>
          </div>
        </div>
        <div id="err" style="margin-top:10px;font-size:13px;color:#dc2626;font-family:monospace"></div>
        <div id="stats" style="margin-top:6px;font-size:12px;color:var(--text-2)"></div>
      </div>

      <div id="pane-tree" style="display:none">
        <div class="btn-group" style="margin-bottom:10px">
          <button class="btn btn-ghost" onclick="expandAll()">Expand All</button>
          <button class="btn btn-ghost" onclick="collapseAll()">Collapse All</button>
        </div>
        <div id="treeView" style="font-family:'SF Mono','Fira Code',monospace;font-size:13px;line-height:1.8;overflow:auto;max-height:520px;background:var(--surface-2,#f8fafc);border:1.5px solid var(--border);border-radius:7px;padding:14px"></div>
        <div id="treeErr" style="font-size:13px;color:#dc2626;margin-top:8px"></div>
      </div>

      <div id="pane-repair" style="display:none">
        <p style="font-size:13px;color:var(--text-2);margin-bottom:12px">Fixes common JSON issues: trailing commas, single quotes, unquoted keys.</p>
        <div class="json-cols">
          <div>
            <label style="margin-bottom:6px">Broken JSON</label>
            <textarea id="repairInput" rows="18" style="font-family:'SF Mono','Fira Code',monospace;font-size:12.5px" placeholder="{name: 'John', age: 30,}"></textarea>
          </div>
          <div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
              <label style="margin:0">Repaired JSON</label>
              <button class="btn btn-copy" id="copyRepairBtn" onclick="copyRepair()">Copy</button>
            </div>
            <div class="json-out" id="repairOutput"></div>
          </div>
        </div>
        <div style="margin-top:10px;display:flex;gap:10px;align-items:center">
          <button class="btn btn-primary" onclick="repairJSON()">Repair JSON</button>
          <div id="repairMsg" style="font-size:13px;color:var(--text-2)"></div>
        </div>
      </div>
    </div>
  </main>
  <footer class="site-footer"><div class="container">Your data never leaves your browser</div></footer>
  <script src="../../assets/common.js"></script>
  <script>
    function switchTab(tab) {
      ['format','tree','repair'].forEach(t => {
        document.getElementById('tab-'+t).classList.toggle('active', t===tab);
        document.getElementById('pane-'+t).style.display = t===tab ? '' : 'none';
      });
      if (tab === 'tree') renderTree();
    }

    function sortObj(obj) {
      if (Array.isArray(obj)) return obj.map(sortObj);
      if (typeof obj === 'object' && obj !== null)
        return Object.keys(obj).sort().reduce((r,k) => { r[k]=sortObj(obj[k]); return r; }, {});
      return obj;
    }

    function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    function highlight(json) {
      return esc(json).replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, m => {
        let cls = 'jn';
        if (/^"/.test(m)) { cls = /:$/.test(m) ? 'jk' : 'js'; }
        else if (/true|false/.test(m)) { cls = 'jb'; }
        else if (/null/.test(m)) { cls = 'jb'; }
        return `<span class="${cls}">${m}</span>`;
      });
    }

    function parseInput() {
      const v = document.getElementById('input').value.trim();
      document.getElementById('err').textContent = '';
      if (!v) return null;
      try { return JSON.parse(v); }
      catch(e) { document.getElementById('err').textContent = 'Parse error: ' + e.message; return null; }
    }

    function liveValidate() {
      const v = document.getElementById('input').value.trim();
      const err = document.getElementById('err');
      if (!v) { err.textContent = ''; return; }
      try { JSON.parse(v); err.textContent = ''; }
      catch(e) { err.textContent = 'Parse error: ' + e.message; }
    }

    function format(sp) {
      let obj = parseInput(); if (obj === null) return;
      if (document.getElementById('sortKeys').checked) obj = sortObj(obj);
      const pretty = JSON.stringify(obj, null, sp);
      document.getElementById('output').innerHTML = highlight(pretty);
      document.getElementById('output').classList.remove('error');
      const numKeys = (pretty.match(/"[^"]+"\s*:/g)||[]).length;
      document.getElementById('stats').textContent = `Keys: ${numKeys} Â· Characters: ${pretty.length} Â· Lines: ${pretty.split('\n').length}`;
    }

    function minify() {
      const obj = parseInput(); if (obj === null) return;
      const min = JSON.stringify(obj);
      document.getElementById('output').innerHTML = highlight(min);
      document.getElementById('stats').textContent = `Minified Â· ${min.length} characters`;
    }

    function copyOut() { copyText(document.getElementById('output').textContent, document.getElementById('copyOutBtn')); }

    function clearAll() {
      document.getElementById('input').value = '';
      document.getElementById('output').innerHTML = '';
      document.getElementById('err').textContent = '';
      document.getElementById('stats').textContent = '';
    }

    // Tree view
    function renderTree() {
      const v = document.getElementById('input').value.trim();
      const treeErr = document.getElementById('treeErr');
      const treeView = document.getElementById('treeView');
      treeErr.textContent = '';
      if (!v) { treeView.innerHTML = '<span style="color:var(--text-2)">Paste JSON in the Format tab first.</span>'; return; }
      try {
        const obj = JSON.parse(v);
        treeView.innerHTML = buildTree(obj, '');
      } catch(e) {
        treeErr.textContent = 'Parse error: ' + e.message;
        treeView.innerHTML = '';
      }
    }

    function buildTree(val, key) {
      const keyHtml = key !== '' ? `<span class="tree-key">${esc(JSON.stringify(key))}: </span>` : '';
      if (val === null) return `<div>${keyHtml}<span class="tree-null">null</span></div>`;
      if (typeof val === 'boolean') return `<div>${keyHtml}<span class="tree-bool">${val}</span></div>`;
      if (typeof val === 'number') return `<div>${keyHtml}<span class="tree-num">${val}</span></div>`;
      if (typeof val === 'string') return `<div>${keyHtml}<span class="tree-str">"${esc(val)}"</span></div>`;
      if (Array.isArray(val)) {
        if (val.length === 0) return `<div>${keyHtml}<span style="color:var(--text-2)">[ ] (empty)</span></div>`;
        const id = 'n' + Math.random().toString(36).slice(2);
        const children = val.map((v,i) => `<div class="tree-node">${buildTree(v, i)}</div>`).join('');
        return `<div id="${id}"><span class="tree-toggle" onclick="toggleNode('${id}')">â–¼</span> ${keyHtml}<span style="color:var(--text-2)">[${val.length} items]</span><div class="tree-children">${children}</div></div>`;
      }
      if (typeof val === 'object') {
        const keys = Object.keys(val);
        if (keys.length === 0) return `<div>${keyHtml}<span style="color:var(--text-2)">{} (empty)</span></div>`;
        const id = 'n' + Math.random().toString(36).slice(2);
        const children = keys.map(k => `<div class="tree-node">${buildTree(val[k], k)}</div>`).join('');
        return `<div id="${id}"><span class="tree-toggle" onclick="toggleNode('${id}')">â–¼</span> ${keyHtml}<span style="color:var(--text-2)">{${keys.length} keys}</span><div class="tree-children">${children}</div></div>`;
      }
      return `<div>${keyHtml}${esc(String(val))}</div>`;
    }

    function toggleNode(id) {
      const el = document.getElementById(id);
      el.classList.toggle('tree-collapsed');
      el.querySelector('.tree-toggle').textContent = el.classList.contains('tree-collapsed') ? 'â–¶' : 'â–¼';
    }

    function expandAll() {
      document.querySelectorAll('#treeView .tree-collapsed').forEach(el => {
        el.classList.remove('tree-collapsed');
        const t = el.querySelector('.tree-toggle'); if (t) t.textContent = 'â–¼';
      });
    }

    function collapseAll() {
      document.querySelectorAll('#treeView [id^="n"]').forEach(el => {
        if (el.querySelector('.tree-children')) {
          el.classList.add('tree-collapsed');
          const t = el.querySelector('.tree-toggle'); if (t) t.textContent = 'â–¶';
        }
      });
    }

    // Repair
    function repairJSON() {
      let s = document.getElementById('repairInput').value;
      const msg = document.getElementById('repairMsg');
      const fixes = [];
      const s1 = s.replace(/,(\s*[\]}])/g, '$1');
      if (s1 !== s) { fixes.push('trailing commas removed'); s = s1; }
      const s2 = s.replace(/'/g, '"');
      if (s2 !== s) { fixes.push('single quotes replaced'); s = s2; }
      const s3 = s.replace(/([{,]\s*)([a-zA-Z_$][a-zA-Z0-9_$]*)\s*:/g, '$1"$2":');
      if (s3 !== s) { fixes.push('unquoted keys quoted'); s = s3; }
      try {
        const parsed = JSON.parse(s);
        const pretty = JSON.stringify(parsed, null, 2);
        document.getElementById('repairOutput').innerHTML = highlight(pretty);
        document.getElementById('repairOutput').classList.remove('error');
        msg.textContent = fixes.length ? 'Fixed: ' + fixes.join(', ') : 'JSON was already valid.';
        msg.style.color = 'var(--success, #16a34a)';
      } catch(e) {
        document.getElementById('repairOutput').textContent = s;
        document.getElementById('repairOutput').classList.add('error');
        msg.textContent = 'Could not fully repair: ' + e.message;
        msg.style.color = '#dc2626';
      }
    }

    function copyRepair() { copyText(document.getElementById('repairOutput').textContent, document.getElementById('copyRepairBtn')); }
  </script>
</body>
</html>
